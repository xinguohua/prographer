# ProGrapher 序列长度一致性实现说明

## 概述
根据用户需求，确保训练和测试阶段使用完全相同的序列长度，实现以下工作流程：

1. **训练阶段**: 使用训练集快照训练ProGrapher模型
2. **测试阶段**: 用训练好的模型对测试集快照进行嵌入预测，然后进行异常检测

## 实现要点

### 1. 统一配置管理 (`sequence_config.py`)
- 定义统一的序列长度: `SEQUENCE_LENGTH = 12`
- 数据分割参数: 恶意窗口±10分钟，测试窗口±20分钟
- 模型参数: 嵌入维度、LSTM层数、卷积参数等

### 2. 训练阶段修改 (`match.py`)
- 导入配置文件并显示参数
- 使用配置文件中的序列长度和模型参数
- 确保训练时的序列长度固定为12

### 3. 测试阶段修改 (`test_graphs.py`)
- 导入相同的配置文件
- **移除动态序列长度调整**，使用固定的序列长度
- 确保测试时的序列长度与训练时完全一致

### 4. 数据使用策略
- **训练集**: 除恶意事件±10分钟和测试事件±20分钟外的所有数据
- **测试集**: 恶意事件±20分钟的数据
- **恶意集**: 暂时不使用（恶意事件±10分钟的数据）

## 关键改进

### 序列长度一致性
- 训练时: 固定使用序列长度12
- 测试时: 固定使用序列长度12（不再动态调整）
- 如果测试集快照数量不足，直接跳过评估并给出警告

### 参数统一管理
- 所有关键参数都在 `sequence_config.py` 中定义
- 训练和测试都从同一配置文件读取参数
- 确保完全一致的模型架构和超参数

### 错误处理
- 检查快照数量是否足够支持指定的序列长度
- 提供清晰的错误信息和调试输出

## 使用方法

### 训练
```bash
python train.py
```
- 使用训练集数据
- 序列长度固定为12
- 保存模型到指定路径

### 测试
```bash
python test_graphs.py
```
- 使用测试集数据
- 序列长度固定为12（与训练一致）
- 加载训练好的模型进行异常检测

## 配置修改
如需修改序列长度或其他参数，只需编辑 `sequence_config.py` 文件即可。
所有相关脚本都会自动使用新的配置。

## 验证序列长度一致性
运行时查看控制台输出：
- 训练阶段会显示"训练使用序列长度: 12"
- 测试阶段会显示"使用固定序列长度: 12 (与训练时严格一致)"
